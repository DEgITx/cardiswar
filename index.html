<head>
<script src="/socket.io/socket.io.js"></script>
<script src="/phaser/phaser.js"></script>
<script src="/phaser-input/phaser-input.js"></script>
<style>
        html, body {
            overflow: hidden;
            width   : 100%;
            height  : 100%;
            margin  : 0;
            padding : 0;
        }

        canvas {
            width   : 100%;
            height  : 100%;
            /* touch-action: none; */
        }
    </style>
<script>
  var socket = io('http://localhost:8099');  
  
  window.addEventListener('DOMContentLoaded', function(){
      var joined = false;
	  var nickInput;
	  var players;
	  var player;
	  var map;
	  var playersCursor = {};
	  var cellCursor = [];
	  var game = new Phaser.Game(window.innerWidth, window.innerHeight, Phaser.AUTO, '', { preload: preload, create: create, update: update });
	  
	  var playerDoingMove = false;

	  function updatePlayers()
	  {
			moneyText.text = 'money: ' + player.money;
			var inventoryCard;
			player.inventory.forEach(function(pl){
				inventoryCard = game.add.sprite((inventoryCard != null ? inventoryCard.x + inventoryCard.width: 32), 32, 'card');
				inventoryCard.scale.set(-5, -5);
			});
	  }
	  
	  socket.on('join', function (data) {
			nickInput.destroy();
	  		moneyText = game.add.text(16, 16, 'money: 0', { fontSize: '32px', fill: '#fff' });
			diceText = game.add.text(500, 16, 'dice: 0', { fontSize: '32px', fill: '#fff' });
			
			stepButton = game.add.button(game.world.centerX - 95, 400, 'button', function(){
				socket.emit('makestep');
			}, this, 2, 1, 0);
			
			buyButton = game.add.button(game.world.centerX - 95, 200, 'button', function(){
				socket.emit('buycard');
			}, this, 2, 1, 0);
	  
			players = data.map.players;
			player = data.player;
			map = data.map.map;
			console.log('Me with id ' + data.player.id + ' joined');
			console.log(map);
			
			updatePlayers();
			for(var i = 0; i < map.length; i++)
			{
				cellCursor[i] = game.add.graphics(0, 0);
				cellCursor[i].lineStyle(2, 0x0000FF, 1);
				cellCursor[i].drawRect(map[i].x, map[i].y, map[i].height, map[i].width);
			}
			for(var id in players)
			{
				playersCursor[id] = game.add.graphics(map[players[id].position].x, map[players[id].position].y);
				playersCursor[id].lineStyle(2, 0xFF00FF, 1);
				playersCursor[id].drawCircle(0, 0, 5);
			}
			
			socket.on('joinplayer', function (data) {
				console.log('Player ' + data.player.id + ' join');
				players[data.player.id] = data.player;
				playersCursor[data.player.id] = game.add.graphics(map[data.player.position].x, map[data.player.position].y + map[data.player.position].height / 2);
				playersCursor[data.player.id].lineStyle(2, 0xFF00FF, 1);
				playersCursor[data.player.id].drawCircle(0, 0, 5);
			});
			
			socket.on('leftplayer', function (data) {
				console.log('Player ' + data.player.id + ' left');
				delete players[data.player.id];
				playersCursor[data.player.id].destroy();
				delete playersCursor[data.player.id];
			});
			
			socket.on('makestep', function(data){
				players = data.players
				if(data.player.id == player.id)
				{
					player = data.player;
				}
				playersCursor[data.player.id].movePoints = data.path;
				playerDoingMove = true;
			});
			
			socket.on('buycard', function(data){
				players = data.players
				if(data.player.id == player.id)
				{
					player = data.player;
				}
				if(data.result)
				{
					cellCursor[player.position].clear();
					cellCursor[player.position].lineStyle(2, 0x00FF00, 1);
					cellCursor[player.position].drawRect(map[player.position].x, map[player.position].y, map[player.position].height, map[player.position].width);
					updatePlayers();
				}
			});
	  });
	  
		function preload() {
			game.load.image('background', 'images/background.jpg');
			
			game.load.image('card', 'images/cards/card.png');
		}
		
		function create() {	
			var background = game.add.image(0, 0, 'background');
			//var backgroundRatio = background.width/background.height
			
			game.add.plugin(Fabrique.Plugins.InputField);
			nickInput = game.add.inputField(game.world.centerX, game.world.centerY, {
				font: '36px Arial',
				fill: '#666666',
				fontWeight: 'bold',
				width: 350,
				height: 45,
				padding: 8,
				borderWidth: 1,
				borderColor: '#000',
				borderRadius: 6,
				placeHolder: 'Your Nick',
			});
			nickInput.x -= nickInput.width / 2;
			nickInput.y -= nickInput.height / 2;
			
			game.input.keyboard.onDownCallback = function(e) {
				if(e.keyCode == 13 && !joined && nickInput.text.text.length > 0)
				{
					joined = true;
					socket.emit('join', { nick: nickInput.text.text});
				}
			};
		}

		function update() {
			if(playerDoingMove)
			{
				var findMovePoint = false;
				for(var id in playersCursor)
				{
					if(playersCursor[id].movePoints != null && playersCursor[id].movePoints.length > 0)
					{
						findMovePoint = true;
						var point = playersCursor[id].movePoints[0];
						if(playersCursor[id].x - map[point].x > 0)
						{
							playersCursor[id].x -= 1;
						}
						
						if(-(playersCursor[id].x - map[point].x) > 0)
						{
							playersCursor[id].x += 1;
						}
						
						if(playersCursor[id].y - map[point].y > 0)
						{
							playersCursor[id].y -= 1;
						}
						
						if(-(playersCursor[id].y - map[point].y) > 0)
						{
							playersCursor[id].y += 1;
						}
						if(Math.abs(playersCursor[id].x - map[point].x) < 1 && Math.abs(playersCursor[id].y - map[point].y) < 1)
						{
							playersCursor[id].movePoints.shift();
						}
					}
				}
				if(!findMovePoint)
				{
					playerDoingMove = false;
					updatePlayers();
				}
			}
		
			
		}

  });
</script>
</head>